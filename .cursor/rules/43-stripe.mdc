---
description: Stripe payment processing patterns
globs: "**/stripe/**/*,**/payments/**/*,**/billing/**/*"
alwaysApply: false
---

# Stripe Automation

## Amount Formatting
**Always use smallest currency unit (cents)**:
- USD: $10.50 = `1050`
- EUR: €10.50 = `1050`
- JPY: ¥1000 = `1000` (no decimals)

## ID Prefixes
| Object | Prefix |
|--------|--------|
| Customer | `cus_` |
| Charge | `ch_` |
| Subscription | `sub_` |
| Invoice | `in_` |
| Product | `prod_` |
| Price | `price_` |
| Payment Intent | `pi_` |
| Refund | `re_` |

## Common Workflows

### Customers
- Search before creating (Stripe allows duplicates)
- Store customer ID in your database
- Use metadata for custom fields

### Payment Flow (Recommended)
1. Create Payment Intent
2. Confirm Payment Intent
3. Handle webhook for async status

### Subscriptions
- Require customer with payment method
- Use Price IDs (not Product IDs) for items
- Cancel: immediate or at period end

### Refunds
- Full: omit amount
- Partial: specify amount in cents
- Reasons: `duplicate`, `fraudulent`, `requested_by_customer`

## Pagination
```
limit: 100 (max)
has_more: boolean
starting_after: last object ID
```

## Best Practices
- Use Payment Intents over direct charges
- Store customer IDs for recurring billing
- Always verify amounts before processing
- Handle webhooks for async payment status
- Test with Stripe test mode keys
