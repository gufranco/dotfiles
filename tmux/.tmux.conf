################################################################################
# Terminal & Display
################################################################################
# RGB color support for modern terminals
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ',xterm-256color:RGB'
set -ga terminal-overrides ',tmux-256color:RGB'
set -ga terminal-overrides ',screen-256color:RGB'
set -ga terminal-overrides ',xterm-kitty:RGB'

# iTerm2 terminal support (RGB + True Color)
set -ga terminal-overrides ',xterm-iterm2:RGB'
set -ga terminal-overrides ',xterm-iterm2:Tc'
set -ga terminal-overrides ',iTerm2:RGB'
set -ga terminal-overrides ',iTerm2:Tc'

# Kitty terminal specific features
set -ga terminal-overrides ',xterm-kitty:Tc'
set -ga terminal-overrides ',xterm-kitty:cnorm=\E[?12l\E[?25h'

################################################################################
# Performance & Behavior
################################################################################
# Address vim mode switching delay (http://superuser.com/a/252717/65504)
set -s escape-time 0

# Increase scrollback buffer size (from default 2000)
set -g history-limit 50000

# Tmux messages are displayed for 4 seconds
set -g display-time 4000

# Refresh status bar more often (default: 15s)
set -g status-interval 5

# Focus events enabled for terminals that support them
set -g focus-events on

# Super useful when using "grouped sessions" and multi-monitor setup
set-window-option -g aggressive-resize on

# Emacs key bindings in tmux command prompt (prefix + :)
set -g status-keys emacs

# Allow longer time to repeat commands (improves pane resizing)
set -g repeat-time 1000

# Extended keys support for Control+Shift bindings (tmux 3.2+)
# Enables Control+Shift key combinations in iTerm2 and mintty
%if #{>=:#{version},3.2}
set -g extended-keys #{?#{||:#{m/ri:mintty|iTerm,#{TERM_PROGRAM}},#{!=:#{XTERM_VERSION},}},on,off}
%endif

################################################################################
# Windows & Panes
################################################################################
# Index windows and panes starting at 1 instead of 0
set -g base-index 1
set-window-option -g pane-base-index 1

# Automatically renumber windows when one is closed
set -g renumber-windows on

# Use vim key bindings in copy mode
set-window-option -g mode-keys vi

# Enable mouse support
set -g mouse on

# Window title settings
set -g allow-rename off
set -g set-titles on
set-window-option -g automatic-rename on

# Silence notifications
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
set-window-option -g monitor-activity off
set -g bell-action none

# Clipboard integration
set -g set-clipboard on

################################################################################
# Keybindings
################################################################################

# Pane Navigation (Vim-style)
# Usage: Prefix + h/j/k/l - Navigate left/down/up/right
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Pane Resizing (Vim-style, repeatable)
# Usage: Prefix + H/J/K/L - Resize left/down/up/right (hold to repeat)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Pane Swapping
# Usage:
#   Prefix + > - Swap current pane with next pane
#   Prefix + < - Swap current pane with previous pane
bind > swap-pane -D
bind < swap-pane -U

# Maximize Pane
# Usage: Prefix + + - Toggle maximize/restore current pane
bind + resize-pane -Z

# Pane Splitting (keeps current path)
# Usage:
#   Prefix + | - Split horizontal (keeps current directory)
#   Prefix + \ - Split horizontal full-width
#   Prefix + - - Split vertical (keeps current directory)
#   Prefix + _ - Split vertical full-height
bind | split-window -h -c "#{pane_current_path}"
bind \\ split-window -fh -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -fv -c "#{pane_current_path}"

# Override default splits to keep current path
# Usage: Prefix + " or % - Default splits now keep directory
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Window Management
# Note: Window swap bindings (< and >) are overridden by pane swap bindings below
# If you prefer window swapping, you can rebind them to other keys
# Usage: Prefix + < or > - Move window left/right (hold to repeat)
# bind -r < swap-window -d -t -1
# bind -r > swap-window -d -t +1

# Window Navigation (repeatable)
# Usage:
#   Prefix + C-h - Previous window (hold to repeat)
#   Prefix + C-l - Next window (hold to repeat)
#   Prefix + Tab - Switch to last active window
bind -r C-h previous-window
bind -r C-l next-window
bind Tab last-window

# Kill Shortcuts
# Usage:
#   Prefix + X - Kill all panes except current
#   Prefix + K - Kill current window (with confirmation)
#   Prefix + x - Kill current pane (native, with confirmation)
#   Prefix + & - Kill window (native, with confirmation)
bind X kill-pane -a
bind K confirm-before -p "Kill window #W? (y/n)" kill-window

# Reload Configuration
# Usage: Prefix + r - Reload tmux config and show confirmation
# Automatically detects config file location using tmux variables
bind r run "sh -c '\"$TMUX_PROGRAM\" \${TMUX_SOCKET:+-S \"$TMUX_SOCKET\"} source \"$TMUX_CONF\"'" \; display "#{TMUX_CONF} reloaded!"

# Edit Configuration
# Usage: Prefix + e - Open tmux config in $EDITOR (or $VISUAL, or vim)
# Automatically reloads config after editing
# Detects editor automatically and sets syntax highlighting for vim
bind e new-window -n "#{TMUX_CONF_LOCAL:-#{TMUX_CONF}}" sh -c '_E=${VISUAL:-${EDITOR:-vim}}; case "$_E" in *vim*) "$_E" -c ":set syntax=tmux" "${TMUX_CONF_LOCAL:-${TMUX_CONF}}";; *) "$_E" "${TMUX_CONF_LOCAL:-${TMUX_CONF}}";; esac && "$TMUX_PROGRAM" ${TMUX_SOCKET:+-S "$TMUX_SOCKET"} source "${TMUX_CONF}" \; display "#{TMUX_CONF} reloaded!"'

# New Window in Current Path
# Usage: Prefix + c - Create new window in current directory
bind c new-window -c "#{pane_current_path}"

# Session Navigation
# Usage:
#   Prefix + BTab (Shift+Tab) - Switch to last session
#   Prefix + C-c - Create new session
#   Prefix + C-f - Find session (opens command prompt to search)
bind BTab switch-client -l
bind C-c new-session
bind C-f command-prompt -p find-session 'switch-client -t %%'

# Synchronize Panes
# Usage: Prefix + S - Toggle sending commands to all panes simultaneously
bind S set-window-option synchronize-panes\; display "Synchronize #{?synchronize-panes,ON,OFF}"

# Clear History
# Usage: Prefix + Ctrl+k - Clear scrollback buffer
bind C-k clear-history \; display "History cleared!"

# Clear Screen and History
# Usage: Prefix + C-l - Clear screen and scrollback history
# Sends C-l to terminal (clears screen) then clears tmux history
# Note: This requires prefix, use -n for no-prefix version (may interfere with normal C-l)
bind C-l send-keys C-l \; run 'sleep 0.2' \; clear-history

# Copy Mode (Vim-style)
# Usage:
#   Prefix + [ - Enter copy mode
#   Prefix + Enter - Enter copy mode (alternative shortcut)
#   v - Start selection (visual mode)
#   C-v - Rectangle selection
#   H - Move to start of line
#   L - Move to end of line
#   Escape - Cancel selection and exit copy mode
#   y - Copy selection and exit (handled by tmux-yank plugin)
#   Y - Copy and paste immediately (from tmux-yank)
bind Enter copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line

# Paste Buffers
# Usage:
#   Prefix + b - List all paste buffers
#   Prefix + p - Paste from most recent buffer
#   Prefix + P - Choose which buffer to paste from (interactive)
bind b list-buffers
bind p paste-buffer -p
bind P choose-buffer

################################################################################
# Plugins
################################################################################
# Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

# Yoru Revamped
set -g @plugin 'gufranco/yoru-revamped-tmux'

# Widget refresh rate
set -g @yoru_revamped_refresh_rate 10

# Widget order
set -g @yoru_revamped_widgets_order "system,git,netspeed,context"

# System Widget
set -g @yoru_revamped_show_system 1
set -g @yoru_revamped_system_cpu 1
set -g @yoru_revamped_system_gpu 0
set -g @yoru_revamped_system_memory 1
set -g @yoru_revamped_system_swap 0
set -g @yoru_revamped_system_disk 1
set -g @yoru_revamped_system_disk_path "/"
set -g @yoru_revamped_system_battery 1
set -g @yoru_revamped_system_battery_threshold 20

# Git Widget
set -g @yoru_revamped_show_git 1
set -g @yoru_revamped_git_untracked 1
set -g @yoru_revamped_git_web 1
set -g @yoru_revamped_git_stash 1
set -g @yoru_revamped_git_ahead_behind 1
set -g @yoru_revamped_git_last_commit 1

# Network Widget
set -g @yoru_revamped_show_netspeed 0
set -g @yoru_revamped_netspeed_ping 1
set -g @yoru_revamped_netspeed_vpn 1
set -g @yoru_revamped_netspeed_vpn_name 0
set -g @yoru_revamped_netspeed_wifi 0

# Context Widget
set -g @yoru_revamped_show_context 1
set -g @yoru_revamped_context_weather 1
set -g @yoru_revamped_context_weather_units "m"
set -g @yoru_revamped_context_date_format YMD
set -g @yoru_revamped_context_time_format 24H
set -g @yoru_revamped_context_timezone 1
set -g @yoru_revamped_context_timezones "America/Los_Angeles,America/New_York"

# Session Wizard - fzf-based session and project switching
# Usage: Prefix + T - Opens fuzzy finder to switch/create sessions
set -g @plugin '27medkamal/tmux-session-wizard'
set -g @session-wizard 'T'

# tmux-resurrect - Save and restore tmux environment
# Usage: Prefix + Ctrl+s (save), Prefix + Ctrl+r (restore)
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'

# tmux-yank - Copy to system clipboard
# Usage: In copy mode, y to copy to clipboard
set -g @plugin 'tmux-plugins/tmux-yank'

# Extrakto - Extract URLs, file paths, hashes with fuzzy finder
# Usage: Prefix + Ctrl+a - Shows all URLs/paths/hashes, select to copy
set -g @plugin 'laktak/extrakto'
set -g @extrakto_key 'C-a'

# tmux-mighty-scroll - Better scrolling in vim, less, man, etc.
# Usage: Automatic - Provides better scrolling in fullscreen apps
set -g @plugin 'noscript/tmux-mighty-scroll'

# tmux-menus - Popup menus for common actions
# Usage: F12 - Opens context menu
set -g @plugin 'jaclu/tmux-menus'
set -g @menus_trigger F12

# Initialize TPM
run '~/.tmux/plugins/tpm/tpm'
