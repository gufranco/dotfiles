---
description: Testing standards
globs: "**/*.test.ts,**/*.spec.ts,**/__tests__/**"
alwaysApply: false
---

# Testing

## Philosophy
Tests should verify real behavior, not mock behavior.

## Priority
1. **Integration** (preferred) → Real database, real services
2. **E2E** → Full user flows
3. **Unit** (fallback) → Pure functions only

## Mocks Policy (STRICT)

### ✅ ALLOWED to Mock
- External APIs (Stripe, Resend, etc.)
- Time/Date (use fake timers)
- Randomness (`crypto.randomUUID()`)

### ❌ NEVER Mock
- Database
- Your own services
- Your own modules
- File system operations

## Test Structure (AAA Pattern)

Every test MUST follow Arrange-Act-Assert with these exact comments:

```typescript
it('should create a user with valid data', async () => {
  // Arrange
  const input = { name: 'John Doe', email: 'john@example.com' };

  // Act
  const result = await userService.create(input);

  // Assert
  expect(result.success).toBe(true);
  expect(result.data.name).toBe('John Doe');
});
```

**Rules:**
- Use ONLY `// Arrange`, `// Act`, `// Assert` comments
- NO additional explanations in comments
- Code should be self-explanatory
- Variable/function names must convey intent

| ❌ NEVER | ✅ CORRECT |
|----------|------------|
| `// Arrange: Create a project` | `// Arrange` |
| `// Act: Call the API` | `// Act` |
| `// Assert: Verify response` | `// Assert` |
| `// Arrange - set up data` | `// Arrange` |
| `// Act & Assert: Test fails` | Separate `// Act` and `// Assert` |

## Test Data
- Use faker for random data
- Use factories for database records
- Clean database between tests

## Test Naming
- Describe **behavior**, not implementation
- Use clear, readable names: `should create user with valid email`
- **NEVER** reference ticket/task IDs in test names or describe blocks
  - ❌ `describe('User Tests (ENG-1234)', ...)`
  - ✅ `describe('User Tests', ...)`
- Test descriptions should be timeless and self-explanatory

## File Location
Colocate: `user-service.ts` → `user-service.test.ts`

## When to Run
- After ANY code change → related tests
- Before commit → full test suite
- **Never** commit with failing tests

## Coverage Requirements
- New code: 80%+ coverage (adjust per project)
- Existing code: Do not reduce coverage
