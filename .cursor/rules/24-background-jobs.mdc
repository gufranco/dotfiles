---
description: Background job and queue patterns
globs: "**/jobs/**,**/workers/**,**/queues/**"
alwaysApply: false
---

# Background Jobs

## Job Structure

### Idempotent by Design
```typescript
// ✅ Safe to retry
async function processPayment(jobData: { paymentId: string }) {
  const payment = await getPayment(jobData.paymentId);
  
  if (payment.status === 'completed') {
    return; // Already processed
  }
  
  await chargeCard(payment);
  await markCompleted(payment.id);
}

// ❌ Not idempotent - will double charge
async function processPayment(amount: number, cardId: string) {
  await chargeCard(cardId, amount);
}
```

### Job Data
```typescript
interface JobData {
  // Reference IDs, not full objects
  resourceId: string;
  resourceType: string;
  
  // Metadata for debugging
  initiatedBy: string;
  initiatedAt: string;
  
  // Optional: idempotency key
  idempotencyKey?: string;
}
```

## Queue Patterns

### Queue Naming
```
{service}.{resource}.{action}

Examples:
- email.notification.send
- payment.invoice.process
- report.daily.generate
```

### Priority Queues
| Priority | Use Case | Example |
|----------|----------|---------|
| Critical | User-blocking | Password reset email |
| High | Time-sensitive | Payment processing |
| Default | Normal operations | Report generation |
| Low | Background tasks | Analytics sync |

## Retry Strategies

### Exponential Backoff
```
attempt | delay
   1    | 1 minute
   2    | 2 minutes
   3    | 4 minutes
   4    | 8 minutes
   5    | 16 minutes
   6    | Dead letter queue
```

### Retry Decision
```typescript
function shouldRetry(error: Error, attempts: number): boolean {
  // Don't retry validation errors
  if (error instanceof ValidationError) return false;
  
  // Don't retry auth errors
  if (error instanceof AuthError) return false;
  
  // Retry transient errors
  if (error instanceof NetworkError) return attempts < 5;
  if (error instanceof TimeoutError) return attempts < 5;
  
  // Default: retry up to 3 times
  return attempts < 3;
}
```

## Dead Letter Queue

### When Jobs Fail
1. Move to dead letter queue (DLQ)
2. Alert on-call team
3. Preserve original job data
4. Allow manual retry/investigation

### DLQ Structure
```typescript
interface DeadLetterJob {
  originalQueue: string;
  jobData: unknown;
  failedAt: string;
  attempts: number;
  lastError: string;
  stackTrace: string;
}
```

## Job Lifecycle

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│ Pending │───►│ Active  │───►│Complete │
└─────────┘    └────┬────┘    └─────────┘
                   │
                   │ error
                   ▼
              ┌─────────┐    ┌─────────┐
              │  Retry  │───►│  Failed │───► DLQ
              └─────────┘    └─────────┘
```

## Concurrency Control

### Worker Limits
```typescript
const queueConfig = {
  'email.send': { concurrency: 10 },
  'report.generate': { concurrency: 2 },
  'payment.process': { concurrency: 5 },
};
```

### Rate Limiting
```typescript
// Limit external API calls
const rateLimiter = {
  'stripe.charge': { max: 100, window: '1m' },
  'email.send': { max: 50, window: '1s' },
};
```

### Unique Jobs
```typescript
// Prevent duplicate jobs
await queue.add('sync.user', { userId: '123' }, {
  jobId: `sync-user-${userId}`, // Unique per user
});
```

## Scheduled Jobs

### Cron Patterns
```typescript
const schedules = {
  'report.daily': '0 6 * * *',      // 6 AM daily
  'cleanup.old': '0 2 * * 0',       // 2 AM Sundays
  'sync.external': '*/15 * * * *',  // Every 15 minutes
};
```

### Time Zones
- Always specify timezone explicitly
- Use UTC for cron definitions
- Convert to user timezone only for display

## Monitoring

### Key Metrics
| Metric | Description |
|--------|-------------|
| Queue depth | Jobs waiting to be processed |
| Processing time | Job duration (p50, p95, p99) |
| Failure rate | Failed jobs / total jobs |
| DLQ size | Jobs in dead letter queue |

### Alerts
- Queue depth > threshold
- Processing time > SLA
- Failure rate spike
- DLQ not empty

## Logging

### Job Start
```json
{
  "event": "job.started",
  "queue": "email.send",
  "jobId": "abc123",
  "attempt": 1
}
```

### Job Complete
```json
{
  "event": "job.completed",
  "queue": "email.send",
  "jobId": "abc123",
  "duration_ms": 150
}
```

### Job Failed
```json
{
  "event": "job.failed",
  "queue": "email.send",
  "jobId": "abc123",
  "error": "SMTP connection failed",
  "attempt": 3,
  "willRetry": false
}
```

## Checklist
- [ ] Jobs are idempotent
- [ ] Retry strategy defined
- [ ] Dead letter queue configured
- [ ] Concurrency limits set
- [ ] Monitoring in place
- [ ] Alerts configured
- [ ] Logging implemented
