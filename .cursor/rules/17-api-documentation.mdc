---
description: API documentation standards
globs: "**/api/**/*.ts"
alwaysApply: false
---

# API Documentation

## OpenAPI Requirements
- For GraphQL or flexible APIs, document and practice requesting only needed fields to avoid over-fetch and extra cost.

All API endpoints MUST be documented in OpenAPI specification.

```typescript
// ❌ NEVER - undocumented endpoint
router.post('/users', createUserHandler);

// ✅ CORRECT - documented with OpenAPI
import { createRoute, z } from '@hono/zod-openapi';

const createUserRoute = createRoute({
  method: 'post',
  path: '/users',
  tags: ['Users'],
  summary: 'Create a new user',
  request: {
    body: {
      content: { 'application/json': { schema: CreateUserSchema } }
    }
  },
  responses: {
    201: {
      description: 'User created successfully',
      content: { 'application/json': { schema: UserResponseSchema } }
    },
    400: {
      description: 'Invalid input',
      content: { 'application/json': { schema: ErrorSchema } }
    }
  }
});
```

## New Endpoint Checklist
When creating a new endpoint:
- [ ] Add Zod schema to `src/modules/*/domain/schemas.ts`
- [ ] Register schema with OpenAPI registry
- [ ] Document request body schema
- [ ] Document response schema (success and error)
- [ ] Document query parameters
- [ ] Document path parameters
- [ ] Specify authentication requirements
- [ ] Add example requests/responses

## Schema Location
Schemas MUST be centralized in module domain files:
```
src/modules/{module}/domain/schemas.ts
```

**Never** define schemas inline in route files.

```typescript
// ❌ NEVER - inline schema in route file
// src/modules/users/routes.ts
const createUserRoute = createRoute({
  request: {
    body: {
      content: {
        'application/json': {
          schema: z.object({  // Inline schema - BAD
            email: z.string().email(),
            name: z.string()
          })
        }
      }
    }
  }
});

// ✅ CORRECT - centralized schema
// src/modules/users/domain/schemas.ts
export const CreateUserSchema = z.object({
  email: z.string().email().openapi({ example: 'user@example.com' }),
  name: z.string().min(1).openapi({ example: 'John Doe' })
}).openapi('CreateUserRequest');

export const UserSchema = z.object({
  id: z.string().uuid(),
  email: z.string().email(),
  name: z.string(),
  createdAt: z.string().datetime()
}).openapi('User');

// src/modules/users/routes.ts
import { CreateUserSchema, UserSchema } from './domain/schemas';

const createUserRoute = createRoute({
  request: {
    body: { content: { 'application/json': { schema: CreateUserSchema } } }
  }
});
```

## Response Format
All endpoints must use standardized response format:

```typescript
// Success
{
  "data": { ... },
  "meta": { "requestId": "...", "timestamp": "..." }
}

// Error
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable message",
    "requestId": "...",
    "timestamp": "..."
  }
}
```

## Authentication Documentation
- Specify if endpoint requires authentication
- Document required roles/permissions
- Use Bearer token scheme in OpenAPI spec

```typescript
// ❌ NEVER - no auth documentation
const getUserRoute = createRoute({
  method: 'get',
  path: '/users/{id}',
  responses: { 200: { description: 'User' } }
});

// ✅ CORRECT - with auth documentation
const getUserRoute = createRoute({
  method: 'get',
  path: '/users/{id}',
  tags: ['Users'],
  security: [{ bearerAuth: [] }],  // Requires authentication
  description: 'Get user by ID. Requires `users:read` permission.',
  responses: {
    200: { description: 'User found' },
    401: { description: 'Unauthorized - missing or invalid token' },
    403: { description: 'Forbidden - insufficient permissions' }
  }
});

// Register security scheme globally
app.openAPIRegistry.registerComponent('securitySchemes', 'bearerAuth', {
  type: 'http',
  scheme: 'bearer',
  bearerFormat: 'JWT'
});
```

## Versioning
- API version in URL path: `/api/v1/resource`
- Document breaking changes in CHANGELOG

| ❌ NEVER | ✅ CORRECT |
|----------|------------|
| `/api/users` | `/api/v1/users` |
| `/users?version=1` | `/api/v1/users` |
| `X-API-Version: 1` header | `/api/v1/users` |

```typescript
// ❌ NEVER - breaking change without versioning
// Old: GET /api/v1/users returns { name, email }
// New: GET /api/v1/users returns { name, emailAddress } - BREAKS CLIENTS

// ✅ CORRECT - new version for breaking changes
// GET /api/v1/users returns { name, email }       - unchanged
// GET /api/v2/users returns { name, emailAddress } - new version

// Route setup
app.route('/api/v1', v1Routes);
app.route('/api/v2', v2Routes);
```
